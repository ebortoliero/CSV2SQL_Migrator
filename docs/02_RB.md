# Requirements Backbone (RB)

---

## 1. Introdução e Escopo

Este documento define o **Requirements Backbone (RB)** do sistema de migração de dados de arquivos CSV para SQL Server, consolidando a intenção estratégica do produto, requisitos funcionais, não funcionais, regras de negócio, restrições, prioridades e rastreabilidade.

O RB é um **contrato formal** entre a intenção do produto e sua execução por IA.  
Tudo o que está definido neste documento **existe**.  
Tudo o que não está definido **não faz parte do sistema**.

Este RB foi derivado exclusivamente de:

- Product Intent aprovado
- Decisões humanas explícitas registradas durante o processo

Todos os requisitos, regras, restrições e contratos técnicos aqui definidos são suportados direta ou indiretamente pelo Product Intent, não havendo dependência de documentos legados, versões anteriores ou decisões externas não registradas.

Nota sobre validação:
Neste Requirements Backbone, não são definidos critérios de aceitação.
A validação de cada requisito ocorre exclusivamente por meio de testes automatizados derivados dos próprios requisitos contratuais (RF/RNF), conforme definido pela metodologia AI-First orientada a contratos.

---

## 2. Requisitos Funcionais (RF)

### RF01 — Indicar pasta raiz de arquivos CSV

Permitir que o usuário informe uma pasta raiz no sistema de arquivos onde estão localizados os arquivos CSV a serem processados.

### RF02 — Descobrir automaticamente arquivos CSV

Descobrir automaticamente arquivos com extensão `.csv` a partir da pasta raiz informada, incluindo todas as subpastas, sem limitação de profundidade.

### RF03 — Filtrar arquivos não elegíveis

Ignorar arquivos que não possuam extensão `.csv` durante o processo de descoberta.

### RF04 — Informar parâmetros de conexão com o banco de dados

Permitir que o usuário informe todos os parâmetros necessários para conexão com o banco de dados SQL Server de destino.

### RF05 — Testar conexão com o banco de dados

Permitir que o usuário teste a conexão com o banco de dados de destino antes de iniciar a migração.

### RF06 — Acionar manualmente o início da migração

Permitir que o usuário acione explicitamente o início do processo de migração após configurar a origem e o destino.

### RF07 — Criar Job de migração

Criar um Job único para cada execução de migração iniciada pelo usuário.

### RF08 — Gerenciar estado do Job

Manter e disponibilizar o estado atual do Job durante todo o seu ciclo de vida.

### RF09 — Processar arquivos CSV de forma independente

Processar cada arquivo CSV de forma independente dentro do mesmo Job, garantindo isolamento de falhas por arquivo.

### RF10 — Processar registros linha a linha

Processar cada registro do arquivo CSV de forma independente, sem interromper o processamento do arquivo por erro em linha individual.

### RF11 — Interromper processamento apenas por falha estrutural

Interromper o processamento somente em caso de falha estrutural que impeça a leitura do arquivo como um todo.

### RF12 — Inferir automaticamente tipos de dados

Inferir automaticamente os tipos de dados das colunas de cada arquivo CSV com base em amostragem determinística definida pelo sistema.

### RF13 — Aplicar fallback para inferência não confiável

Aplicar tipo genérico quando a inferência de tipo de uma coluna for considerada não confiável.

### RF14 — Criar tabelas SQL automaticamente

Criar automaticamente uma tabela no banco de dados de destino para cada arquivo CSV processado.

### RF15 — Derivar nomes de tabelas de forma determinística

Derivar o nome da tabela SQL a partir do nome do arquivo CSV, garantindo unicidade e reprodutibilidade.

### RF16 — Registrar erros de processamento

Registrar erros ocorridos durante o processamento, associando-os ao Job, arquivo, linha e coluna.

### RF17 — Persistir erros para auditoria

Manter os registros de erro disponíveis para consulta após a finalização do Job.

### RF18 — Medir métricas de execução

Registrar métricas de execução do Job, incluindo linhas lidas, inseridas e rejeitadas.

### RF19 — Calcular percentual de aproveitamento

Calcular o percentual de aproveitamento dos dados com base nas métricas registradas.

### RF20 — Disponibilizar progresso do Job durante execução

Disponibilizar informações de progresso do Job enquanto ele estiver em execução.

### RF21 — Permitir reprocessamento controlado

Permitir o reprocessamento de um Job completo ou de um arquivo específico, criando sempre um novo Job e preservando o histórico.

### RF22 — Recriar estrutura de tabela em reprocessamento

Remover e recriar a tabela SQL correspondente quando um arquivo CSV for reprocessado.

### RF23 — Registrar tempos de execução

Registrar horários de início e término de cada Job.

---

## 3. Requisitos Não Funcionais (RNF)

### RNF01 — Desempenho de migração por arquivo

O sistema deve executar a migração de cada arquivo CSV com tempo de processamento mensurável e registrável.

### RNF02 — Previsibilidade de execução

Sob condições equivalentes de entrada e ambiente, o sistema deve apresentar comportamento previsível.

### RNF03 — Resiliência a falhas pontuais

Falhas em registros ou arquivos individuais não devem interromper a execução global do Job.

### RNF04 — Determinismo e reprodutibilidade

Sob as mesmas condições de entrada e configuração, os resultados devem ser reproduzíveis.

### RNF05 — Auditabilidade completa

Todas as decisões de processamento e rejeição devem ser registradas e consultáveis.

### RNF06 — Segurança mínima obrigatória

O sistema deve proteger credenciais, usar conexões seguras e prevenir injeção de comandos.

### RNF07 — Compatibilidade com SQL Server on-premise

O sistema deve operar exclusivamente com SQL Server on-premise a partir da versão 2008.

### RNF08 — Independência de infraestrutura em nuvem

O sistema não deve depender de serviços ou infraestrutura em nuvem.

### RNF09 — Escalabilidade por paralelismo controlado

O sistema deve permitir paralelismo por arquivo, com controle interno de concorrência.

### RNF10 — Persistência de histórico

Histórico de execuções, métricas e erros deve ser preservado integralmente.

### RNF11 — Disponibilidade de indicadores operacionais

Indicadores de execução, tempo e qualidade devem estar disponíveis durante e após o processamento.

---

## 4. Regras de Negócio (RN)

### RN01 — Início explícito da migração

A migração somente pode ser iniciada por ação explícita do usuário.

### RN02 — Validação prévia obrigatória da conexão

A migração só pode iniciar se a conexão tiver sido validada com sucesso.

### RN03 — Processamento resiliente por linha

Erros em linhas individuais não interrompem o processamento das demais.

### RN04 — Interrupção apenas por falha estrutural

Falhas estruturais interrompem apenas o arquivo afetado, não o Job.

### RN05 — Ausência de rollback global

Falhas pontuais não geram rollback global.

### RN06 — Auditoria obrigatória de rejeições

Toda rejeição deve ser registrada de forma auditável.

### RN07 — Preservação de dados válidos

Dados válidos devem ser preservados mesmo na presença de falhas.

### RN08 — Determinismo das decisões de inferência

Inferências devem produzir o mesmo resultado sob as mesmas condições.

### RN09 — Criação de novo Job em reprocessamento

Todo reprocessamento gera um novo Job.

### RN10 — Recriação estrutural em reprocessamento

Reprocessamento exige remoção e recriação da estrutura da tabela.

### RN11 — Aceitação de perdas controladas

Perdas de dados são aceitáveis se mensuráveis e auditáveis.

### RN12 — Exclusividade de ambiente

Execução permitida apenas em infraestrutura interna.

### RN13 — Conformidade com plataforma alvo

O banco de destino deve ser SQL Server on-premise compatível.

---

## 5. Restrições e Limites

- Execução exclusivamente em infraestrutura interna
- Proibição total de dependência em nuvem
- Banco de destino restrito a SQL Server on-premise
- Proibição de rollback global automático
- Não garantir qualidade perfeita dos dados
- Proibição de normalizações além das explicitamente permitidas
- Proibição de execução automática sem ação humana
- IA não pode tomar decisões estratégicas
- Falhas localizadas não interrompem o Job
- Nenhum descarte pode ocorrer sem auditoria
- Ajustes avançados de infraestrutura estão fora do escopo

---

## 6. Priorização dos Requisitos

### P0 — Obrigatórios

RF01 a RF20  
RNF01 a RNF08

### P1 — Necessários para operação completa

RF21, RF22, RF23  
RNF09, RNF10, RNF11

### P2 — Desejáveis

Nenhum

---

## 7. Rastreabilidade com o Product Intent

Todos os RF, RNF e RN deste documento são rastreáveis ao:

- Problema Central
- Limites Invioláveis
- Métricas de Sucesso
- Escopo Excluído
- Restrições Estratégicas
  do Product Intent aprovado e às decisões humanas explícitas registradas.

---

## 8. Contratos Técnicos Obrigatórios (Congelados)

Esta seção define contratos de execução obrigatórios e tecnologicamente neutros,
necessários para garantir que os requisitos possam ser implementados e testados
de forma determinística por uma IA.

Os contratos aqui definidos NÃO representam decisões arquiteturais,
NÃO selecionam tecnologias e NÃO antecipam escolhas de implementação.

Qualquer decisão técnica, arquitetural ou tecnológica pertence exclusivamente
ao Architecture Pack.

---

### 8.1 Contrato de Leitura de CSV (Dialeto e Parsing)

O sistema deve suportar **autodetecção heurística de delimitador**, considerando os seguintes candidatos:

- Vírgula (`,`)
- Ponto e vírgula (`;`)
- Tabulação (`\t`)
- Barra vertical (`|`)
- Dois pontos (`:`)
- Espaço simples (` `)
- Sequências de múltiplos caracteres (ex.: `||`, `;;`)

Regras:

- A IA deve identificar automaticamente o delimitador correto com base na consistência estrutural das linhas.
- Caso não seja possível determinar o delimitador de forma confiável, o arquivo deve ser tratado como **falha estrutural**.
- A leitura deve ocorrer obrigatoriamente em **streaming**, sem carregamento integral em memória.

Regra adicional:

- Em caso de empate entre delimitadores candidatos, deve prevalecer o delimitador que:
  1. produza menor variância no número de colunas entre linhas; e
  2. seja mais comum na seguinte ordem de prioridade:
     `;`, `,`, `\t`, `|`, `:`, espaço.

---

### 8.2 Encoding Suportado

- O sistema deve tentar **detecção automática de encoding** por heurística/biblioteca.
- Caso a detecção falhe, deve aplicar **fallback automático para Windows-1252**.
- Encoding ilegível após fallback caracteriza **falha estrutural**.

---

### 8.3 Cabeçalho (Header)

- Todo arquivo CSV **deve conter cabeçalho obrigatório**.
- Arquivos sem cabeçalho válido devem ser classificados como **falha estrutural**.
- O cabeçalho define o número esperado de colunas.

---

### 8.4 Tratamento de Linhas

- Linhas vazias devem ser ignoradas.
- Todos os campos devem sofrer `trim`.
- Linhas com número de colunas diferente do cabeçalho:
  - devem ser tratadas como **erro de linha**;
  - a linha deve ser rejeitada;
  - o erro deve ser registrado;
  - o processamento do arquivo deve continuar.

---

### 8.5 Definição Fechada de Falha Estrutural

São consideradas **falhas estruturais** exclusivamente:

- Arquivo inacessível ou sem permissão
- Encoding ilegível (mesmo após fallback)
- Delimitador não determinável
- Cabeçalho inválido ou ausente
- Erro de I/O durante leitura

Regras:

- Falha estrutural interrompe apenas o arquivo afetado.
- O Job deve continuar com os demais arquivos.

---

### 8.6 Inferência Determinística de Tipos

- A inferência deve utilizar **amostragem determinística de até 5.000 linhas válidas**, após o cabeçalho.
- Caso o arquivo possua menos de 5.000 linhas, todas as linhas existentes devem ser amostradas.
- A inferência é considerada **não confiável** se **menos de 90%** dos valores amostrados forem compatíveis com o tipo candidato.

Tipos SQL permitidos:

- `int`
- `bigint`
- `decimal(p,s)` (precisão e escala inferidas da amostra)
- `datetime`
- `bit`
- `nvarchar(255)`
- `nvarchar(max)`

Empate entre tipos:

- Deve prevalecer o tipo **mais conservador**, priorizando ingestão:
  - `nvarchar(255)` ou `nvarchar(max)` quando aplicável.

---

### 8.7 Naming Determinístico de Tabelas

- Cada arquivo CSV deve gerar uma tabela no formato:

  `TB_<NomeArquivoSemExtensao>`

- **Não deve ser utilizado hash** no nome da tabela.
- Caso o nome da tabela já exista:
  - deve ser aplicado um **prefixo numérico sequencial de dois dígitos** (`01_`, `02_`, etc.).
- A regra deve ser determinística dentro do escopo do Job.

Regra adicional:

- Não é permitido reprocessar simultaneamente o mesmo arquivo dentro do mesmo Job.
- Caso exista tentativa concorrente de recriação da mesma tabela, o sistema deve serializar a operação por tabela.

---

### 8.8 Sanitização de Nomes de Coluna

- Substituir espaços e pontuação por `_`.
- Remover caracteres inválidos para SQL Server.
- Colunas sem nome devem ser renomeadas para `COL###`.
- Colunas duplicadas devem receber sufixos `_2`, `_3`, etc.

---

### 8.9 Tamanho de Colunas Texto

- O tamanho padrão deve ser `nvarchar(255)`.
- Caso a amostra indique valores maiores, utilizar `nvarchar(max)`.

---

## Declaração Final

**Este Requirements Backbone foi derivado exclusivamente do Product Intent fornecido e de decisões humanas explícitas.  
Não houve invenção de escopo.**

Este documento é a **fonte única da verdade** para a implementação do sistema.

---
