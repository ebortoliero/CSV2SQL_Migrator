# Architecture Pack (AP) â€” MÃ­nimo ViÃ¡vel

---

## 1. Objetivo do Architecture Pack

Este Architecture Pack tem como objetivo **congelar todas as decisÃµes tÃ©cnicas essenciais** para permitir a implementaÃ§Ã£o automÃ¡tica e previsÃ­vel do sistema por IA.  
Ele define linguagem, runtime, estilo arquitetural, stack, estrutura de pastas, padrÃµes e restriÃ§Ãµes, eliminando ambiguidades e **bloqueando improvisaÃ§Ã£o tÃ©cnica** durante a execuÃ§Ã£o.  
Este documento Ã© a **fonte Ãºnica de decisÃ£o arquitetural** para a fase de codificaÃ§Ã£o.

---

## 2. DecisÃµes Arquiteturais Congeladas

- **DecisÃ£o:** Linguagem principal = **C#**  
  **Justificativa objetiva:** Linguagem fortemente tipada, madura, previsÃ­vel e amplamente utilizada em ambientes Windows on-premise, adequada para processamento intensivo de IO, concorrÃªncia controlada e integraÃ§Ã£o nativa com SQL Server.  
  **Origem:** IC Â§2.1 / Â§3.2; RB RNF02, RNF04, RNF06, RNF07, RNF08.

- **DecisÃ£o:** Runtime = **.NET 8 (LTS)**  
  **Justificativa objetiva:** VersÃ£o LTS garante estabilidade, previsibilidade operacional e suporte prolongado. VersÃµes STS (ex.: .NET 9) nÃ£o trazem ganho funcional ou de throughput relevante para este contexto e aumentam risco operacional.  
  **Origem:** RB RNF02, RNF04, RNF06, RNF07, RNF08; IC Â§3.2.

- **DecisÃ£o:** Camada Web em **ASP.NET Core â€” Razor Pages**  
  **Justificativa objetiva:** Interface predominantemente administrativa (configuraÃ§Ã£o, acionamento, acompanhamento e histÃ³rico). Razor Pages reduz boilerplate, acelera implementaÃ§Ã£o por IA e aumenta previsibilidade estrutural.  
  **Origem:** IC Â§3.2; RB RF01â€“RF06, RF16â€“RF21, RNF11.

- **DecisÃ£o:** Estilo arquitetural = **MonÃ³lito em Camadas**  
  **Justificativa objetiva:** Atende integralmente os requisitos com menor complexidade, maior rastreabilidade, melhor controle de paralelismo e menor risco operacional do que arquiteturas distribuÃ­das.  
  **Origem:** IC Â§3.2; RB RNF02, RNF03, RNF05, RNF09, RNF10.

- **DecisÃ£o:** EstratÃ©gia obrigatÃ³ria de ingestÃ£o de dados =  
  **streaming + bulk insert + paralelismo controlado por arquivo**  
  **Justificativa objetiva:** NecessÃ¡ria para processar milhares de arquivos CSV, incluindo arquivos com mais de 1 milhÃ£o de linhas, priorizando throughput mÃ¡ximo com estabilidade, controle de memÃ³ria e previsibilidade.  
  **Origem:** RB RNF01, RNF02, RNF04, RNF09; RF09; IC Â§3.2.

- **DecisÃ£o:** PersistÃªncia de estado, auditoria, mÃ©tricas e erros em **SQL Server on-premise**  
  **Justificativa objetiva:** NecessÃ¡ria para histÃ³rico de jobs, acompanhamento de progresso, auditoria e rastreabilidade apÃ³s execuÃ§Ã£o.  
  **Origem:** RB RF07â€“RF23, RNF05, RNF10, RNF11, RN06, RN10.

- **DecisÃ£o:** Velocidade validada por **mÃ©trica mÃ­nima obrigatÃ³ria de desempenho**  
  **Justificativa objetiva:** Garante que a arquitetura atenda ao objetivo de processamento rÃ¡pido de grandes volumes por meio de validaÃ§Ã£o mensurÃ¡vel e repetÃ­vel.  
  **Origem:** RB RNF01, RNF04, RNF11; IC Â§4.

---

## 3. Linguagem e Stack TecnolÃ³gica

- **Linguagem:** C#
- **Runtime:** .NET 8 (LTS)
- **Web UI:** ASP.NET Core â€” Razor Pages
- **Banco de Dados:** SQL Server on-premise (2008 ou superior)
- **Acesso a dados:** Microsoft.Data.SqlClient (ADO.NET)
- **ConcorrÃªncia:** Task Parallel Library (TPL) + SemaphoreSlim

### EstratÃ©gias obrigatÃ³rias

- **Leitura de CSV:** exclusivamente em **streaming**, linha a linha ou em buffers controlados.
- **Escrita no banco:** exclusivamente via **bulk insert nativo**, com escrita em **lotes configurÃ¡veis**.
- **ConcorrÃªncia:** paralelismo **somente no nÃ­vel de arquivos**, com limite explÃ­cito e configurÃ¡vel.

**FundamentaÃ§Ã£o:** RB RNF01, RNF02, RNF04, RNF07, RNF09; RF09.

### EstratÃ©gia de Bulk Insert

DecisÃ£o:

- Bulk insert deve ser implementado via **SqlBulkCopy (ADO.NET)**.

ParÃ¢metros mÃ­nimos obrigatÃ³rios:

- BatchSize configurÃ¡vel
- BulkCopyTimeout configurÃ¡vel
- Escrita em tabela de destino criada pelo sistema (RF14/RF15)
- Qualquer falha por linha deve ser registrada (RF16) sem invalidar o Job

---

## 4. Estilo Arquitetural

**Estilo:** MonÃ³lito em Camadas

### Camadas

- **Web:** Razor Pages (UI fina, sem lÃ³gica de processamento pesado)
- **Application:** orquestraÃ§Ã£o de jobs, regras de execuÃ§Ã£o, controle de paralelismo, coleta de mÃ©tricas
- **Domain:** modelos e regras invariantes (Job, Arquivo, Erro, MÃ©trica)
- **Infrastructure:** leitura de CSV, acesso ao SQL Server, criaÃ§Ã£o/recriaÃ§Ã£o de tabelas, persistÃªncia

### Impactos esperados

- ImplementaÃ§Ã£o direta e previsÃ­vel por IA
- Alto throughput com controle de recursos
- EvoluÃ§Ã£o incremental sem quebra arquitetural

---

## 4.1 Modelo de ExecuÃ§Ã£o do Processamento â€” Congelado

- O processamento de migraÃ§Ã£o **nÃ£o pode** ocorrer no thread de uma requisiÃ§Ã£o HTTP.
- A UI (Razor Pages) apenas:
  - cria/configura o Job;
  - aciona inÃ­cio do Job;
  - consulta progresso, mÃ©tricas e erros.

DecisÃ£o congelada:

- A execuÃ§Ã£o do Job deve ocorrer em **processamento em background no mesmo host da aplicaÃ§Ã£o**, via mecanismo nativo (ex.: fila em memÃ³ria + BackgroundService/HostedService), mantendo:
  - controle de concorrÃªncia por arquivo (SemaphoreSlim);
  - persistÃªncia de estado no SQL Server;
  - possibilidade de consulta de progresso durante execuÃ§Ã£o.

---

## 5. Estrutura de Pastas

/src
/Web
/Pages
/Jobs
/Config
/Monitoring
/wwwroot
Program.cs

/Application
/Jobs
/Services
/Ports

/Domain
/Models
/ValueObjects
/Rules

/Infrastructure
/Csv
/SqlServer
/Persistence

/tests
/Unit
/Integration

/docs

ğŸ“Œ Regras obrigatÃ³rias associadas Ã  estrutura

1. Razor Pages

- Toda interface web DEVE estar contida em /Web/Pages.
- Subpastas em /Pages sÃ£o obrigatÃ³rias para organizaÃ§Ã£o funcional (ex.: Jobs, Config, Monitoring).
- A estrutura de pastas em /Pages define diretamente as rotas da aplicaÃ§Ã£o.

2. Program.cs

- Program.cs DEVE residir dentro de /Web.
- Nenhum outro projeto pode conter ponto de entrada da aplicaÃ§Ã£o web.

3. SeparaÃ§Ã£o de Camadas

- /Web â†’ apenas UI, binding e validaÃ§Ãµes simples.
- /Application â†’ orquestraÃ§Ã£o, fluxo de jobs, regras de execuÃ§Ã£o.
- /Domain â†’ modelos e regras invariantes, sem dependÃªncias tÃ©cnicas.
- /Infrastructure â†’ IO, CSV, SQL Server, persistÃªncia.

4, ProibiÃ§Ãµes explÃ­citas

- Ã‰ proibido acessar SQL diretamente a partir de /Web.
- Ã‰ proibido implementar lÃ³gica de processamento pesado em PageModel.
- Ã‰ proibido criar pÃ¡ginas fora de /Web/Pages.

---

## 5.1 DocumentaÃ§Ã£o Governada do Projeto

O diretÃ³rio `/docs` Ã© a **fonte oficial e exclusiva de documentaÃ§Ã£o governada** deste projeto.

Regras obrigatÃ³rias:

- Todos os artefatos formais de governanÃ§a (Product Intent, Requirements Backbone, Intent Contract, Architecture Pack) **DEVEM** residir em `/docs`.
- Apenas os documentos contidos em `/docs` possuem **autoridade normativa**.
- Nenhum outro artefato fora deste diretÃ³rio (README, comentÃ¡rios em cÃ³digo, issues, commits, mensagens, etc.) pode:
  - redefinir requisitos,
  - alterar decisÃµes arquiteturais,
  - introduzir escopo,
  - ou contradizer os documentos oficiais.

Qualquer divergÃªncia entre cÃ³digo e documentaÃ§Ã£o governada deve ser resolvida **sempre a favor dos documentos em `/docs`**.

A IA DEVE:

- ler integralmente os documentos contidos em `/docs` antes de iniciar a codificaÃ§Ã£o;
- ignorar qualquer informaÃ§Ã£o encontrada fora desse diretÃ³rio para fins de decisÃ£o.

---

## 5.2 Estrutura de Solution e Projetos (.sln)

A soluÃ§Ã£o deve ser composta por **4 projetos** (um por camada), para garantir separaÃ§Ã£o clara e testes previsÃ­veis.

- `/src/Company.Product.sln`
- `/src/Web/Company.Product.Web.csproj`
- `/src/Application/Company.Product.Application.csproj`
- `/src/Domain/Company.Product.Domain.csproj`
- `/src/Infrastructure/Company.Product.Infrastructure.csproj`

Regras de referÃªncia (permitidas):

- Web â†’ Application
- Application â†’ Domain
- Infrastructure â†’ Application e Domain
- Domain â†’ **nenhuma dependÃªncia** de outras camadas

Qualquer desvio destas regras deve ser escalado.

---

## 6. PadrÃµes e ConvenÃ§Ãµes ObrigatÃ³rias

- **Nomenclatura**

  - Projetos: Company.Product.Web / Application / Domain / Infrastructure
  - Classes: PascalCase
  - VariÃ¡veis: camelCase

- **UI (Razor Pages)**

  - Toda funcionalidade de UI deve existir como **Page** em `/Web/Pages`.
  - O `PageModel` nÃ£o pode conter lÃ³gica de processamento pesado.

- **Banco de Dados**

  - Uso obrigatÃ³rio de comandos parametrizados.
  - DDL e DML somente na camada Infrastructure.

- **Commits**
  - Commits pequenos e rastreÃ¡veis por RF / RNF / RN.

---

## 7. RestriÃ§Ãµes TÃ©cnicas

- Ã‰ **terminantemente proibido**:

  - carregar arquivos CSV inteiros em memÃ³ria;
  - realizar inserÃ§Ãµes linha a linha no banco de dados;
  - paralelizar processamento em nÃ­vel de linha ou registro;
  - utilizar serviÃ§os de nuvem ou dependÃªncias externas;
  - utilizar versÃµes **STS** do runtime .NET.

- Todo processamento deve:

  - ser determinÃ­stico e reprodutÃ­vel;
  - respeitar limites explÃ­citos de concorrÃªncia;
  - priorizar a estabilidade do SQL Server sobre paralelismo agressivo.

- **Reprocessamento:**  
  Em caso de reprocessamento de um arquivo, os dados e a tabela correspondente devem ser removidos e a tabela recriada.

**Origem:** RB RNF02, RNF04, RNF08, RNF09, RN05, RN10, RestriÃ§Ãµes e Limites.

---

---

## 7.1 PersistÃªncia Interna (Schema Congelado)

A aplicaÃ§Ã£o deve persistir informaÃ§Ãµes internas para auditoria, progresso e histÃ³rico.

- Schema: `dbo`
- Tabelas obrigatÃ³rias:

### Jobs

- Id (INT IDENTITY)
- CreatedAt
- StartedAt
- FinishedAt
- Status
- RootFolder
- TotalFiles
- ProcessedFiles

### JobFiles

- Id (INT IDENTITY)
- JobId (FK)
- FilePath
- Status
- StartedAt
- FinishedAt
- LinesRead
- LinesInserted
- LinesRejected
- TableName

### JobErrors

- Id (INT IDENTITY)
- JobId (FK)
- JobFileId (FK)
- LineNumber (nullable)
- ColumnName (nullable)
- ErrorType
- Message
- CreatedAt

### JobMetrics

- Id (INT IDENTITY)
- JobId (FK)
- MetricName
- MetricValue
- RecordedAt

Regras:

- O histÃ³rico Ã© imutÃ¡vel.
- Reprocessamentos criam novos Jobs e preservam execuÃ§Ãµes anteriores.

---

## 8. Diretrizes para ExecuÃ§Ã£o por IA

- A IA deve tratar este Architecture Pack como **fonte congelada**.
- A IA deve implementar obrigatoriamente:

  - leitura em streaming;
  - escrita via bulk insert;
  - paralelismo restrito ao nÃ­vel de arquivos.

- **MÃ©trica mÃ­nima obrigatÃ³ria de validaÃ§Ã£o de desempenho**

  - tempo total de processamento;
  - volume total processado;
  - taxa mÃ©dia de processamento (linhas/segundo ou MB/segundo).

- A IA pode refatorar cÃ³digo para melhorar desempenho **desde que**:
  - nÃ£o altere linguagem, runtime, stack ou estilo arquitetural;
  - nÃ£o viole as restriÃ§Ãµes de ingestÃ£o e paralelismo;
  - nÃ£o contradiga qualquer decisÃ£o congelada neste documento.

---

## 8.1 Artefatos MÃ­nimos de Teste (Fixtures)

A soluÃ§Ã£o deve conter dados de teste versionados para validar RF/RNF com repetibilidade:

- `/tests/Fixtures/csv/`
  - `small_ok.csv` (pequeno e vÃ¡lido)
  - `large_ok.csv` (grande, para throughput)
  - `heterogeneous_delimiter.csv` (se suportar mÃºltiplos delimitadores)
  - `invalid_lines.csv` (linhas com erro para validar RF10/RF16)
  - `structural_failure.csv` (caso representativo de falha estrutural)

Regras:

- Testes de integraÃ§Ã£o devem validar, no mÃ­nimo: RF02, RF07, RF09â€“RF11, RF14â€“RF22 e RNF04/RNF05/RNF10/RNF11.

---

## 9. Rastreabilidade com RB e IC

- **C# / .NET 8 (LTS):** RB RNF02, RNF04, RNF06, RNF07, RNF08; IC Â§3.2
- **Razor Pages:** RB RF01â€“RF06, RF16â€“RF21, RNF11; IC Â§3.2
- **MonÃ³lito em Camadas:** RB RNF02, RNF03, RNF05, RNF09, RNF10; IC Â§3.2
- **Streaming + Bulk + Paralelismo por arquivo:** RB RNF01, RNF02, RNF04, RNF09; RF09
- **SQL Server on-premise:** RB RNF07, RNF08, RN12, RN13
- **MÃ©trica mÃ­nima de desempenho:** RB RNF01, RNF04, RNF11; IC Â§4

---

### DeclaraÃ§Ã£o Final

> **â€œEste Architecture Pack foi gerado exclusivamente a partir do Requirements Backbone e do Intent Contract, respeitando todas as autorizaÃ§Ãµes e restriÃ§Ãµes.â€**

### Gate Humano

âœ… **APROVADO** â€” Este Architecture Pack Ã© a base oficial para execuÃ§Ã£o automÃ¡tica do cÃ³digo.  
A partir deste ponto, **nenhuma decisÃ£o arquitetural pode ser alterada sem revisÃ£o formal**.
