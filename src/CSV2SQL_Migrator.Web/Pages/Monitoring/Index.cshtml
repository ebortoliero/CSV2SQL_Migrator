@page
@model CSV2SQL_Migrator.Web.Pages.Monitoring.IndexModel
@{
    ViewData["Title"] = "Monitoramento de Job";
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (Model.Job == null)
{
    <div class="alert alert-warning">
        Job não encontrado.
    </div>
    <a asp-page="/Jobs/Index" class="btn btn-secondary">Voltar para Jobs</a>
}
else
{
    <div class="row">
        <div class="col-12">
            <h2>Monitoramento - Job #@Model.Job.Id</h2>
            <hr />

            <!-- Informações do Job -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Informações do Job</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>Status:</strong>
                            @switch (Model.Job.Status)
                            {
                                case Domain.Models.JobStatus.Created:
                                    <span class="badge bg-secondary">Criado</span>
                                    break;
                                case Domain.Models.JobStatus.Running:
                                    <span class="badge bg-primary">Em Execução</span>
                                    break;
                                case Domain.Models.JobStatus.Completed:
                                    <span class="badge bg-success">Concluído</span>
                                    break;
                                case Domain.Models.JobStatus.Failed:
                                    <span class="badge bg-danger">Falhou</span>
                                    break;
                                case Domain.Models.JobStatus.Cancelled:
                                    <span class="badge bg-warning">Cancelado</span>
                                    break;
                            }
                        </div>
                        <div class="col-md-3">
                            <strong>Pasta Raiz:</strong> @Model.Job.RootFolder
                        </div>
                        <div class="col-md-3">
                            <strong>Arquivos:</strong> @Model.Job.ProcessedFiles / @Model.Job.TotalFiles
                        </div>
                        <div class="col-md-3">
                            <strong>RF23 - Criado em:</strong> @Model.Job.CreatedAt.ToString("dd/MM/yyyy HH:mm:ss")
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <strong>RF23 - Iniciado em:</strong> @(Model.Job.StartedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? "-")
                        </div>
                        <div class="col-md-3">
                            <strong>RF23 - Finalizado em:</strong> @(Model.Job.FinishedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? "-")
                        </div>
                        @if (Model.UtilizationPercentage.HasValue)
                        {
                            <div class="col-md-3">
                                <strong>RF19 - Aproveitamento:</strong> 
                                <span class="badge @(Model.UtilizationPercentage >= 90 ? "bg-success" : Model.UtilizationPercentage >= 70 ? "bg-warning" : "bg-danger")">
                                    @Model.UtilizationPercentage.Value.ToString("F2")%
                                </span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Progresso em tempo real (RF20) -->
            @if (Model.Job.Status == Domain.Models.JobStatus.Running)
            {
                <div class="alert alert-info">
                    <strong>RF20 - Progresso em Tempo Real:</strong> Este job está em execução. 
                    A página será atualizada automaticamente.
                </div>
                <script>
                    setTimeout(function() {
                        location.reload();
                    }, 5000); // Atualizar a cada 5 segundos
                </script>
            }

            <!-- Arquivos Processados -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Arquivos Processados</h5>
                </div>
                <div class="card-body">
                    @if (Model.JobFiles.Count == 0)
                    {
                        <p class="text-muted">Nenhum arquivo processado ainda.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Arquivo</th>
                                        <th>Status</th>
                                        <th>Tabela</th>
                                        <th>Linhas Lidas</th>
                                        <th>Linhas Inseridas</th>
                                        <th>Linhas Rejeitadas</th>
                                        <th>Iniciado</th>
                                        <th>Finalizado</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var file in Model.JobFiles)
                                    {
                                        <tr>
                                            <td>@System.IO.Path.GetFileName(file.FilePath)</td>
                                            <td>
                                                @switch (file.Status)
                                                {
                                                    case Domain.Models.JobFileStatus.Pending:
                                                        <span class="badge bg-secondary">Pendente</span>
                                                        break;
                                                    case Domain.Models.JobFileStatus.Processing:
                                                        <span class="badge bg-primary">Processando</span>
                                                        break;
                                                    case Domain.Models.JobFileStatus.Completed:
                                                        <span class="badge bg-success">Concluído</span>
                                                        break;
                                                    case Domain.Models.JobFileStatus.Failed:
                                                        <span class="badge bg-danger">Falhou</span>
                                                        break;
                                                }
                                            </td>
                                            <td>@file.TableName</td>
                                            <td>@file.LinesRead.ToString("N0")</td>
                                            <td>@file.LinesInserted.ToString("N0")</td>
                                            <td>@file.LinesRejected.ToString("N0")</td>
                                            <td>@(file.StartedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? "-")</td>
                                            <td>@(file.FinishedAt?.ToString("dd/MM/yyyy HH:mm:ss") ?? "-")</td>
                                            <td>
                                                @if (file.Status == Domain.Models.JobFileStatus.Completed || file.Status == Domain.Models.JobFileStatus.Failed)
                                                {
                                                    <form method="post" asp-page-handler="ReprocessFile" asp-route-jobId="@Model.Job.Id" asp-route-jobFileId="@file.Id" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('RF21-RF22: Tem certeza? A tabela @file.TableName será removida e recriada. Um novo Job será criado.');">
                                                            Reprocessar
                                                        </button>
                                                    </form>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>

            <!-- Erros (RF17) -->
            @if (Model.JobErrors.Count > 0)
            {
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        <h5>RF17 - Erros Registrados (@Model.JobErrors.Count)</h5>
                    </div>
                    <div class="card-body">
                        @{
                            var errorsByType = Model.JobErrors.GroupBy(e => e.ErrorType).ToList();
                            var errorsByFile = Model.JobErrors
                                .Where(e => e.JobFileId.HasValue)
                                .GroupBy(e => e.JobFileId.Value)
                                .Select(g => new { FileId = g.Key, FileName = Model.JobFileNames.ContainsKey(g.Key) ? Model.JobFileNames[g.Key] : $"ID: {g.Key}", Count = g.Count() })
                                .OrderByDescending(x => x.Count)
                                .Take(10)
                                .ToList();
                        }
                        
                        <!-- Resumo Estatístico dos Erros -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <strong>Erros por Tipo</strong>
                                    </div>
                                    <div class="card-body">
                                        <ul class="list-unstyled mb-0">
                                            @foreach (var group in errorsByType.OrderByDescending(g => g.Count()))
                                            {
                                                var typeName = group.Key switch
                                                {
                                                    Domain.Models.ErrorType.StructuralFailure => "Falha Estrutural",
                                                    Domain.Models.ErrorType.LineError => "Erro de Linha",
                                                    Domain.Models.ErrorType.ColumnError => "Erro de Coluna",
                                                    Domain.Models.ErrorType.DatabaseError => "Erro de Banco",
                                                    Domain.Models.ErrorType.Other => "Outro",
                                                    _ => group.Key.ToString()
                                                };
                                                var percentage = (decimal)group.Count() / Model.JobErrors.Count * 100;
                                                <li class="mb-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <span>@typeName</span>
                                                        <div>
                                                            <span class="badge bg-primary">@group.Count()</span>
                                                            <small class="text-muted">(@percentage.ToString("F1")%)</small>
                                                        </div>
                                                    </div>
                                                    <div class="progress" style="height: 5px;">
                                                        <div class="progress-bar" role="progressbar" style="width: @percentage%" aria-valuenow="@percentage" aria-valuemin="0" aria-valuemax="100"></div>
                                                    </div>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <strong>Top 10 Arquivos com Mais Erros</strong>
                                    </div>
                                    <div class="card-body">
                                        @if (errorsByFile.Any())
                                        {
                                            <ul class="list-unstyled mb-0">
                                                @foreach (var fileError in errorsByFile)
                                                {
                                                    <li class="mb-2">
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <small class="text-break" style="max-width: 70%;">@fileError.FileName</small>
                                                            <span class="badge bg-danger">@fileError.Count</span>
                                                        </div>
                                                    </li>
                                                }
                                            </ul>
                                        }
                                        else
                                        {
                                            <p class="text-muted mb-0">Nenhum erro associado a arquivos específicos.</p>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr />
                        
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-sm table-hover">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 8%;">Linha</th>
                                        <th style="width: 20%;">Arquivo</th>
                                        <th style="width: 12%;">Coluna</th>
                                        <th style="width: 10%;">Tipo</th>
                                        <th style="width: 35%;">Mensagem de Erro</th>
                                        <th style="width: 10%;">Data/Hora</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        int errorIndex = 1;
                                    }
                                    @foreach (var error in Model.JobErrors.Take(500))
                                    {
                                        var fileName = error.JobFileId.HasValue && Model.JobFileNames.ContainsKey(error.JobFileId.Value)
                                            ? Model.JobFileNames[error.JobFileId.Value]
                                            : (error.JobFileId?.ToString() ?? "N/A");
                                        
                                        var errorTypeDisplay = error.ErrorType switch
                                        {
                                            Domain.Models.ErrorType.StructuralFailure => "Falha Estrutural",
                                            Domain.Models.ErrorType.LineError => "Erro de Linha",
                                            Domain.Models.ErrorType.ColumnError => "Erro de Coluna",
                                            Domain.Models.ErrorType.DatabaseError => "Erro de Banco",
                                            Domain.Models.ErrorType.Other => "Outro",
                                            _ => error.ErrorType.ToString()
                                        };

                                        var errorTypeBadge = error.ErrorType switch
                                        {
                                            Domain.Models.ErrorType.StructuralFailure => "bg-danger",
                                            Domain.Models.ErrorType.LineError => "bg-warning",
                                            Domain.Models.ErrorType.ColumnError => "bg-info",
                                            Domain.Models.ErrorType.DatabaseError => "bg-danger",
                                            Domain.Models.ErrorType.Other => "bg-secondary",
                                            _ => "bg-secondary"
                                        };

                                        var messagePreview = error.Message.Length > 150 
                                            ? error.Message.Substring(0, 150) + "..." 
                                            : error.Message;
                                        
                                        <tr class="@(error.ErrorType == Domain.Models.ErrorType.StructuralFailure || error.ErrorType == Domain.Models.ErrorType.DatabaseError ? "table-danger" : "")">
                                            <td class="text-muted">@errorIndex</td>
                                            <td>
                                                @if (error.LineNumber.HasValue)
                                                {
                                                    <span class="badge bg-primary">@error.LineNumber.Value.ToString("N0")</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <small class="text-break" title="@fileName">
                                                    @if (error.JobFileId.HasValue && Model.JobFileNames.ContainsKey(error.JobFileId.Value))
                                                    {
                                                        <strong>@fileName</strong>
                                                        <br />
                                                        <span class="text-muted">ID: @error.JobFileId.Value</span>
                                                    }
                                                    else if (error.JobFileId.HasValue)
                                                    {
                                                        <span class="text-muted">ID: @error.JobFileId.Value</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/A</span>
                                                    }
                                                </small>
                                            </td>
                                            <td>
                                                @if (!string.IsNullOrWhiteSpace(error.ColumnName))
                                                {
                                                    <span class="badge bg-secondary" title="Coluna com erro">@error.ColumnName</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="badge @errorTypeBadge" title="@errorTypeDisplay">@errorTypeDisplay</span>
                                            </td>
                                            <td>
                                                <div class="error-message-container">
                                                    @if (error.Message.Length > 150)
                                                    {
                                                        <div class="error-message-preview" id="error-preview-@error.Id">
                                                            <span>@messagePreview</span>
                                                            <button type="button" class="btn btn-link btn-sm p-0 ms-2 text-decoration-none" onclick="toggleErrorDetail(@error.Id)" title="Ver detalhes completos">
                                                                ▼ Ver mais
                                                            </button>
                                                        </div>
                                                        <div class="error-message-full d-none" id="error-full-@error.Id">
                                                            <div class="alert alert-light border p-2 mb-0">
                                                                <pre class="mb-0 text-wrap" style="white-space: pre-wrap; word-wrap: break-word; font-size: 0.875rem;">@error.Message</pre>
                                                            </div>
                                                            <button type="button" class="btn btn-link btn-sm p-0 mt-1 text-decoration-none" onclick="toggleErrorDetail(@error.Id)" title="Ocultar detalhes">
                                                                ▲ Ver menos
                                                            </button>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-wrap">@error.Message</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <small class="text-muted">@error.CreatedAt.ToString("dd/MM/yyyy")<br />@error.CreatedAt.ToString("HH:mm:ss")</small>
                                            </td>
                                        </tr>
                                        errorIndex++;
                                    }
                                </tbody>
                            </table>
                            @if (Model.JobErrors.Count > 500)
                            {
                                <div class="alert alert-warning mb-0 mt-2">
                                    <strong>⚠ Atenção:</strong> Mostrando apenas os primeiros 500 erros de <strong>@Model.JobErrors.Count</strong> erros totais registrados.
                                    <br />
                                    <small>Para análise completa, consulte o banco de dados diretamente.</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <script>
                    function toggleErrorDetail(errorId) {
                        const preview = document.getElementById('error-preview-' + errorId);
                        const full = document.getElementById('error-full-' + errorId);
                        
                        if (preview && full) {
                            if (full.classList.contains('d-none')) {
                                preview.classList.add('d-none');
                                full.classList.remove('d-none');
                            } else {
                                preview.classList.remove('d-none');
                                full.classList.add('d-none');
                            }
                        }
                    }
                </script>
            }

            <!-- Métricas (RF18) -->
            @if (Model.JobMetrics.Count > 0)
            {
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>RF18 - Métricas de Execução</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Métrica</th>
                                        <th>Valor</th>
                                        <th>Registrado em</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var metric in Model.JobMetrics)
                                    {
                                        <tr>
                                            <td>@metric.MetricName</td>
                                            <td>@metric.MetricValue.ToString("N2")</td>
                                            <td>@metric.RecordedAt.ToString("dd/MM/yyyy HH:mm:ss")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }

            <div class="mt-3">
                <a asp-page="/Jobs/Index" class="btn btn-secondary">Voltar para Jobs</a>
            </div>
        </div>
    </div>
}

